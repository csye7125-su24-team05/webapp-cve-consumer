package kafka

import (
	"context"
	"strings"

	"github.com/csye7125-su24-team05/webapp-cve-consumer/internal/helper"
	"github.com/rs/zerolog/log"
	"github.com/segmentio/kafka-go"
	"github.com/segmentio/kafka-go/sasl/plain"
)

type Kafka interface {
	FetchMessage() (kafka.Message, error)
	CommitMessages(messages ...kafka.Message) error
	Close()
}

type kafkaReader struct {
	Dialer *kafka.Dialer
	Reader *kafka.Reader
	ctx context.Context
}

func NewKafka() Kafka {
	topic := helper.GetEnv("KAFKA_TOPIC", "")
	groupID := helper.GetEnv("KAFKA_GROUP_ID", "")
	broker := helper.GetEnv("KAFKA_BROKER", "")
	mechanism := plain.Mechanism{
		Username: helper.GetEnv("KAFKA_USERNAME", ""),
		Password: helper.GetEnv("KAFKA_PASSWORD", ""),
	}

	dialer := &kafka.Dialer{
		SASLMechanism: mechanism,
	}
	log.Info().Str("broker", broker).Str("topic", topic).Str("groupID", groupID)
	kafkaReader := &kafkaReader{
		Dialer: dialer,
		Reader: kafka.NewReader(kafka.ReaderConfig{
			Brokers: strings.Split(broker, ";"),
			Topic:   topic,
			GroupID: groupID,
			Dialer:  dialer,
		}),
		ctx: context.Background(),
	}

	return kafkaReader
}

func (k *kafkaReader) Close() {
	if err := k.Reader.Close(); err != nil {
		log.Error().Err(err).Msg("error closing kafka reader")
	}
}

func (k *kafkaReader) FetchMessage() (kafka.Message, error) {
	message, err := k.Reader.FetchMessage(k.ctx)
	if err != nil {
		log.Error().Err(err).Msg("error fetching message from kafka")
		return kafka.Message{}, err
	}
	return message, nil
}

func (k *kafkaReader) CommitMessages(messages ...kafka.Message) error {
	err := k.Reader.CommitMessages(k.ctx, messages...)
	if err != nil {
		log.Error().Err(err).Msg("error committing messages")
		return err
	}
	return nil
}
