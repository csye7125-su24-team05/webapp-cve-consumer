package main

import (
	"context"
	"log"
	"os"

	"github.com/csye7125-su24-team05/webapp-cve-consumer/internal/helper"
	"github.com/segmentio/kafka-go"
	"github.com/segmentio/kafka-go/sasl/plain"
	"gorm.io/driver/postgres"
	"gorm.io/gorm"
)

func main() {
	CheckDBConection()
	CheckKafka()
}

func CheckDBConection() {
	dbHost := helper.GetEnv("DB_HOST", "localhost")
	dbUser := helper.GetEnv("DB_USER", "")
	dbPassword := helper.GetEnv("DB_PASSWORD", "")
	dbName := helper.GetEnv("DB_NAME", "")
	dbPort := helper.GetEnv("DB_PORT", "5432")
	dsn := "host=" + dbHost + " user=" + dbUser + " password=" + dbPassword + " dbname=" + dbName + " port=" + dbPort + " sslmode=disable TimeZone=UTC"
	conn, err := gorm.Open(postgres.Open(dsn), &gorm.Config{})
	if err != nil {
		log.Fatalf("error connecting to database: %v", err.Error())
		os.Exit(1)
	}
	db, err := conn.DB()
	if err != nil {
		log.Fatalf("error getting database connection: %v", err.Error())
		os.Exit(1)
	}
	defer db.Close()
	err = conn.Exec("SELECT 1").Error
	if err != nil {
		log.Fatalf("error pinging database: %v", err.Error())
		os.Exit(1)
	} 
	log.Println("database connection successful")
}

func CheckKafka() {
	topic := helper.GetEnv("KAFKA_TOPIC", "")
	broker := helper.GetEnv("KAFKA_BROKER", "")
	mechanism := plain.Mechanism{
		Username: helper.GetEnv("KAFKA_USERNAME", ""),
		Password: helper.GetEnv("KAFKA_PASSWORD", ""),
	}

	dialer := &kafka.Dialer{
		SASLMechanism: mechanism,
	}

	ctx := context.Background()
	conn, err := dialer.DialContext(ctx, "tcp", broker)
	if err != nil {
		log.Fatalf("error connecting to kafka: %v", err.Error())
		os.Exit(1)
	}
	
	defer conn.Close()
	partition, err := conn.ReadPartitions()
	if err != nil {
		log.Fatalf("error reading partitions: %v", err.Error())
		os.Exit(1)
	}
	for _, p := range partition {
		if p.Topic == topic {
			log.Printf("topic %v exists", topic)
			return
		}
	}
	log.Fatalf("topic %v does not exist", topic)
}