package main

import (
	"encoding/json"
	"log"
	"os"
	"syscall"

	"github.com/csye7125-su24-team05/webapp-cve-consumer/internal/db"
	"github.com/csye7125-su24-team05/webapp-cve-consumer/internal/helper"
	"github.com/csye7125-su24-team05/webapp-cve-consumer/internal/kafka"
	"github.com/csye7125-su24-team05/webapp-cve-consumer/internal/models"
)

func main() {
	log.Println("Starting consumer...")
	db := db.NewDB()
	kafka := kafka.NewKafka()
	signal := helper.NewOSSignal()
	signal.Notify(os.Interrupt, syscall.SIGTERM, syscall.SIGINT)
	go processMessages(db, kafka)
	<-signal.Channel()
	log.Println("Shutting down consumer...")
}


func processMessages(db db.DB, k kafka.Kafka) {
	defer db.Close()
	defer k.Close()
	for {
		message, err := k.FetchMessage()
		if err != nil {
			log.Printf("error fetching message: %v", err.Error())
			if err == syscall.EPIPE {
				log.Println("reconnecting to kafka")
				k.Close()
				k = kafka.NewKafka()
			}
		}
		cve_record := models.CVE{}
		err = json.Unmarshal(message.Value, &cve_record)
		if err != nil {
			log.Printf("error unmarshalling message: %v", err.Error())
			k.CommitMessages(message)
			continue
		}
		err = db.Ping()
		if err != nil {
			log.Printf("error connecting database: %v", err.Error())
			continue
		}
		log.Printf("inserting record: %v", cve_record.CveID)
		err = db.InsertCVE(&cve_record)
		if err != nil {
			log.Printf("error inserting record: %v", err.Error())
			continue
		}
		err = k.CommitMessages(message)
		if err != nil {
			log.Printf("error committing message: %v", err.Error())
			continue
		}
	}
}