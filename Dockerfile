# Stage 1: Build stage
FROM golang:1.22 AS builder

WORKDIR /webapp-consumer

COPY . .

RUN go mod download && CGO_ENABLED=0 go build -o ./build/cve-consumer ./app/cve-consumer && CGO_ENABLED=0 go build -o ./build/readiness ./app/readiness && CGO_ENABLED=0 go build -o ./build/liveness ./app/liveness

# Stage 2: Final stage
FROM alpine:3.20

WORKDIR /webapp-consumer

COPY --from=builder /webapp-consumer/build/cve-consumer ./build/cve-consumer
COPY --from=builder /webapp-consumer/build/readiness ./build/readiness
COPY --from=builder /webapp-consumer/build/liveness ./build/liveness

RUN chmod +x ./build/cve-consumer && chmod +x ./build/readiness && chmod +x ./build/liveness

ENTRYPOINT [ "./build/cve-consumer" ]
